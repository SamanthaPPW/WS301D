{% extends 'base.html.twig' %}

{% block title %}Réservation{% endblock %}

{% block body %}
    <a href="{{ path('app_accueil') }}">< Retour vers l'accueil</a>
    <img src="{{ ('images/peigne.svg') }}" alt="Peigne">
    <h1>Services</h1>
        <ul>
            <p>Chez Patoune, nous vpus proposons plusieurs services afin d'apporter le meilleur à vos animaux.</p>
            <p>(Un bain est toujours accompagné de son séchage)</p>
        </ul>
    <br>
    <h2>Toilettage complet</h2>
    <ul>
        <p>Il est composé d'une tonte, d'un bain et d'un peignage.</p>
    </ul>
    <br>
    <h2>Toilettage à la carte</h2>
    <ul>
        <li>Tonte classique uniquement</li>
        <li>Coupe aux ciseaux uniquement</li>
        <li>Tonte avec bain</li>
        <li>Coupe aux ciseaux avec bain</li>
        <li>Bain sans peignage</li>
        <li>Bain avec peignage</li>
        <li>Peignage uniquement</li>
    </ul>
    <br>
    <img src="{{ asset('images/Nox.png') }}" alt="Nox">
    <br>
    <h2>Mon secteur</h2>
    <img src="{{ asset('images/Carte.png') }}" alt="Carte">
    <br>
    <h2>Tarifs</h2>
    <img src="{{ asset('images/Tableau_tarifs.png') }}" alt="Tableau des tarifs">
    <br>
    <h2>Réservation</h2>
    <br>
    <ul>
        <p>Chez Patoune, nous vous proposons plusieurs méthodes de prise de rendez-vous, par mail, par téléphone et sur les réseaux.</p>
    </ul>

    {{ form_start(form) }}

    <fieldset>
        <legend>Informations Générales</legend>
        <div class="form-group">
            {{ form_label(form.nom_proprio) }}
            {{ form_widget(form.nom_proprio) }}
            {{ form_errors(form.nom_proprio) }}
        </div>
        <div class="form-group">
            {{ form_label(form.telephone) }}
            {{ form_widget(form.telephone) }}
            {{ form_errors(form.telephone) }}
        </div>
        <div class="form-group">
            {{ form_label(form.email) }}
            {{ form_widget(form.email) }}
            {{ form_errors(form.email) }}
        </div>
        <div class="form-group">
            {{ form_label(form.adresse) }}
            {{ form_widget(form.adresse) }}
            {{ form_errors(form.adresse) }}
        </div>
        <div class="form-group">
            {{ form_label(form.code_postal) }}
            {{ form_widget(form.code_postal) }}
            {{ form_errors(form.code_postal) }}
        </div>
        <div class="form-group">
            {{ form_label(form.ville) }}
            {{ form_widget(form.ville) }}
            {{ form_errors(form.ville) }}
        </div>
    </fieldset>

    <fieldset>
        <legend>Informations de l’animal</legend>
        <div class="form-group">
            {{ form_label(form.nom_animal) }}
            {{ form_widget(form.nom_animal) }}
            {{ form_errors(form.nom_animal) }}
        </div>
        <div class="form-group">
            {{ form_label(form.animal) }}
            {{ form_widget(form.animal) }}
            {{ form_errors(form.animal) }}
        </div>
        <div class="form-group">
            {{ form_label(form.race) }}
            {{ form_widget(form.race) }}
            {{ form_errors(form.race) }}
        </div>
        <div class="form-group">
            {{ form_label(form.comportement_animal) }}
            {{ form_widget(form.comportement_animal) }}
            {{ form_errors(form.comportement_animal) }}
        </div>
    </fieldset>

    <fieldset>
        <legend>Réservation</legend>
        <div class="form-group">
            {{ form_label(form.creneau_date) }}
            {{ form_widget(form.creneau_date) }}
            <div id="date-error" style="color:red; font-size:0.9em; margin-top:3px;"></div>
            {{ form_errors(form.creneau_date) }}
        </div>
        <div class="form-group">
            {{ form_label(form.creneau_heure) }}
            {{ form_widget(form.creneau_heure) }}
            {{ form_errors(form.creneau_heure) }}
        </div>
        <div class="form-group">
            {{ form_label(form.commentaires) }}
            {{ form_widget(form.commentaires) }}
            {{ form_errors(form.commentaires) }}
        </div>
    </fieldset>

    <div class="form-group">
        {{ form_widget(form.submit) }}
    </div>

    {{ form_end(form) }}

    <script>
        const selectRace = document.querySelector("select[name='reservation[race]']");
        const selectCreneau = document.querySelector("select[name='reservation[creneau_heure]']");
        const racesData = {{ racesData|json_encode|raw }};
        const allCreneaux = {{ allCreneaux|json_encode|raw }};
        const animalInputs = document.querySelectorAll("input[name='reservation[animal]']");

        function clearOptions(select, label="Sélectionner") {
            select.innerHTML = `<option value=''>${label}</option>`;
        }

        function populateRaces(animalType) {
            clearOptions(selectRace);
            if (!animalType || !racesData[animalType]) return;
            Object.keys(racesData[animalType]).forEach(race => {
                const option = document.createElement("option");
                option.value = race;
                option.textContent = race;
                selectRace.appendChild(option);
            });
            clearOptions(selectCreneau);
        }

        animalInputs.forEach(input => {
            input.addEventListener("change", e => populateRaces(e.target.value));
        });

        // Au chargement
        const checkedAnimal = document.querySelector("input[name='reservation[animal]']:checked");
        if (checkedAnimal) populateRaces(checkedAnimal.value);

        selectRace.addEventListener("change", () => {
            const animalType = document.querySelector("input[name='reservation[animal]']:checked")?.value;
            const race = selectRace.value;
            clearOptions(selectCreneau);
            if (!animalType || !race || race === "autre") return;
            const typePoils = racesData[animalType][race];
            allCreneaux[typePoils].forEach(creneau => {
                const option = document.createElement("option");
                option.value = creneau;
                option.textContent = creneau;
                selectCreneau.appendChild(option);
            });
        });

        const dateInput = document.querySelector("input[name='reservation[creneau_date]']");
        const submitBtn = document.querySelector("button[type='submit']");
        const errorDiv = document.getElementById('date-error');

        function checkDay() {
            const selectedDate = new Date(dateInput.value);
            const day = selectedDate.getDay(); // 0 = dimanche, 1 = lundi
            if (day === 0 || day === 1) {
                errorDiv.textContent = "Les réservations ne sont pas possibles le dimanche et le lundi.";
                submitBtn.disabled = true;
            } else {
                errorDiv.textContent = "";
                submitBtn.disabled = false;
            }
        }

        // Vérifie à chaque changement
        dateInput.addEventListener("change", checkDay);
        // Vérifie au chargement si une date est déjà sélectionnée
        checkDay();
    </script>

{% endblock %}
