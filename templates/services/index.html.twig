{% extends 'base.html.twig' %}

{% block title %}Réservation{% endblock %}

{% block body %}
    <h1>Réservation</h1>

    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="flash-{{ label }}">{{ message }}</div>
        {% endfor %}
    {% endfor %}

    {{ form_start(form) }}

    <fieldset>
        <legend>Informations Générales</legend>
        {{ form_row(form.nom_proprio) }}
        {{ form_row(form.telephone) }}
        {{ form_row(form.email) }}
        {{ form_row(form.adresse) }}
        {{ form_row(form.code_postal) }}
        {{ form_row(form.ville) }}
    </fieldset>

    <fieldset>
        <legend>Informations de l’animal</legend>
        {{ form_row(form.nom_animal) }}
        {{ form_row(form.animal) }}
        {{ form_row(form.race) }}
        {{ form_row(form.comportement_animal) }}
    </fieldset>

    <fieldset>
        <legend>Réservation</legend>
        {{ form_row(form.creneau_date) }}
        {{ form_row(form.creneau_heure) }}
        {{ form_row(form.commentaires) }}
    </fieldset>


    {{ form_row(form.submit) }}

    {{ form_end(form) }}

    <script>
        const selectRace = document.querySelector("select[name='reservation[race]']");
        const selectCreneau = document.querySelector("select[name='reservation[creneau_heure]']");
        const durations = {{ durations|json_encode|raw }};
        const racesData = {{ racesData|json_encode|raw }};

        function generateTimeOptions(duration) {
            const startHour = 10;
            const endHour = 19;
            const options = [];
            for (let hour = startHour; hour < endHour; hour++) {
                let start = hour.toString().padStart(2,'0') + ":00";
                let endMinutes = duration;
                let endHourCalc = hour + Math.floor(endMinutes/60);
                let endMinCalc = endMinutes % 60;
                if (endHourCalc >= endHour) break;
                let end = endHourCalc.toString().padStart(2,'0') + ":" + endMinCalc.toString().padStart(2,'0');
                options.push(start + " - " + end);
            }
            return options;
        }

        selectRace.addEventListener("change", () => {
            const animalTypeInput = document.querySelector("input[name='reservation[animal]']:checked");
            if (!animalTypeInput) return;
            const animalType = animalTypeInput.value;
            const race = selectRace.value;

            selectCreneau.innerHTML = "<option value=''>Sélectionner un créneau</option>";
            if (!race || race === "autre") return;

            const typePoils = racesData[animalType][race];
            const duration = durations[typePoils];

            generateTimeOptions(duration).forEach(opt => {
                const option = document.createElement("option");
                option.value = opt;
                option.textContent = opt;
                selectCreneau.appendChild(option);
            });
        });

    </script>

{% endblock %}
