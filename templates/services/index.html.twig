{% extends 'base.html.twig' %}

{% block title %}Réservation{% endblock %}

{% block body %}
    <header>
        <img src="{{ ('images/logo_patoune.png') }}" alt="Logo">
        <nav>
            <a {#href="{{  path('accueil') }}"#}>Accueil</a>
            <a {#href="{{  path('rendez-vous') }}"#}>Rendez-vous</a>
            <a {#href="{{  path('services') }}"#}>Services</a>
            <a {#href="{{  path('souvenir') }}"#}>Galerie</a>
            <a {#href="{{  path('actualité') }}"#}>Actualité</a>
        </nav>
    </header>

    <a href="{{ path('app_accueil') }}">< Retour vers l'accueil</a>
    <img src="{{ ('images/peigne.svg') }}" alt="Peigne">
    <h1>Services</h1>
        <ul>
            <p>Chez Patoune, nous vous proposons plusieurs services afin d'apporter le meilleur à vos animaux.</p>
            <p>(Un bain est toujours accompagné de son séchage)</p>
        </ul>
    <br>
    <h2>Toilettage complet</h2>
    <ul>
        <p>Il est composé d'une tonte, d'un bain et d'un peignage.</p>
    </ul>
    <br>
    <h2>Toilettage à la carte</h2>
    <ul>
        <li>Tonte classique uniquement</li>
        <li>Coupe aux ciseaux uniquement</li>
        <li>Tonte avec bain</li>
        <li>Coupe aux ciseaux avec bain</li>
        <li>Bain sans peignage</li>
        <li>Bain avec peignage</li>
        <li>Peignage uniquement</li>
    </ul>
    <br>
    <img src="{{ asset('images/Nox.png') }}" alt="Nox">
    <br>
    <h2>Mon secteur</h2>
    <img src="{{ asset('images/Carte.png') }}" alt="Carte">
    <br>
    <h2>Tarifs</h2>
    <img src="{{ asset('images/Tableau_tarifs.png') }}" alt="Tableau des tarifs">
    <br>
    <h2>Réservation</h2>
    <br>
    <ul>
        <p>Chez Patoune, nous vous proposons plusieurs méthodes de prise de rendez-vous, par mail, par téléphone et sur les réseaux.</p>
    </ul>

    {{ form_start(form) }}

    <fieldset>
        <legend>Informations Générales</legend>
        <div class="form-group">
            {{ form_label(form.nom_proprio) }}
            {{ form_widget(form.nom_proprio) }}
            {{ form_errors(form.nom_proprio) }}
        </div>
        <div class="form-group">
            {{ form_label(form.telephone) }}
            {{ form_widget(form.telephone) }}
            {{ form_errors(form.telephone) }}
        </div>
        <div class="form-group">
            {{ form_label(form.email) }}
            {{ form_widget(form.email) }}
            {{ form_errors(form.email) }}
        </div>
        <div class="form-group">
            {{ form_label(form.adresse) }}
            {{ form_widget(form.adresse) }}
            {{ form_errors(form.adresse) }}
        </div>
        <div class="form-group">
            {{ form_label(form.code_postal) }}
            {{ form_widget(form.code_postal) }}
            {{ form_errors(form.code_postal) }}
        </div>
        <div class="form-group">
            {{ form_label(form.ville) }}
            {{ form_widget(form.ville) }}
            {{ form_errors(form.ville) }}
        </div>
    </fieldset>

    <fieldset>
        <legend>Informations de l’animal</legend>
        <div class="form-group">
            {{ form_label(form.nom_animal) }}
            {{ form_widget(form.nom_animal) }}
            {{ form_errors(form.nom_animal) }}
        </div>
        <div class="form-group">
            {{ form_label(form.animal) }}
            {{ form_widget(form.animal) }}
            {{ form_errors(form.animal) }}
        </div>
        <div class="form-group">
            {{ form_label(form.race) }}
            {{ form_widget(form.race) }}
            {{ form_errors(form.race) }}
        </div>
        <div class="form-group">
            {{ form_label(form.comportement_animal) }}
            {{ form_widget(form.comportement_animal) }}
            {{ form_errors(form.comportement_animal) }}
        </div>
    </fieldset>

    <fieldset>
        <legend>Réservation</legend>
        <div class="form-group">
            {{ form_label(form.creneau_date) }}
            {{ form_widget(form.creneau_date) }}
            <div id="date-error" style="color:red; font-size:0.9em; margin-top:3px;"></div>
            {{ form_errors(form.creneau_date) }}
        </div>
        <div class="form-group">
            {{ form_label(form.creneau_heure) }}
            {{ form_widget(form.creneau_heure) }}
            {{ form_errors(form.creneau_heure) }}
        </div>
        <div class="form-group">
            {{ form_label(form.commentaires) }}
            {{ form_widget(form.commentaires) }}
            {{ form_errors(form.commentaires) }}
        </div>

        <div class="form-group">
            {{ form_label(form.prestation) }}
            {{ form_widget(form.prestation) }}
            {{ form_errors(form.prestation) }}
        </div>
        <p id="prix-estime">Prix estimé : 0€</p>
    </fieldset>

    <div class="form-group">
        {{ form_widget(form.submit) }}
    </div>

    {{ form_end(form) }}

    <script>
        const selectRace = document.querySelector("select[name='reservation[race]']");
        const selectCreneau = document.querySelector("select[name='reservation[creneau_heure]']");
        const prestationSelect = document.querySelector("select[name='reservation[prestation]']");
        const prixEstime = document.getElementById('prix-estime');
        const animalInputs = document.querySelectorAll("input[name='reservation[animal]']");
        const dateInput = document.querySelector("input[name='reservation[creneau_date]']");
        const submitBtn = document.querySelector("button[type='submit']");
        const errorDiv = document.getElementById('date-error');

        const racesData = {{ racesData|json_encode|raw }};
        const allCreneaux = {{ allCreneaux|json_encode|raw }};
        const prixParPoils = {{ prixParPoils|json_encode|raw }};

        // Fonction pour vider une select
        function clearOptions(select, placeholder="Sélectionner") {
            select.innerHTML = `<option value="">${placeholder}</option>`;
        }

        // Remplir les races en fonction de l'animal choisi
        function populateRaces(animalType) {
            clearOptions(selectRace, "Sélectionner une race");
            clearOptions(selectCreneau, "Sélectionner un créneau");
            if (!animalType || !racesData[animalType]) return;

            Object.keys(racesData[animalType]).forEach(race => {
                const option = document.createElement("option");
                option.value = race;
                option.textContent = race;
                selectRace.appendChild(option);
            });
        }

        // Mettre à jour les créneaux et le prix
        function updateCreneauxEtPrix() {
            const animalType = document.querySelector("input[name='reservation[animal]']:checked")?.value;
            const race = selectRace.value;
            const prestation = prestationSelect.value;

            // Créneaux
            clearOptions(selectCreneau, "Sélectionner un créneau");
            if (animalType && race && race !== "autre") {
                const typePoils = racesData[animalType][race];
                if (!allCreneaux[typePoils] || !Array.isArray(allCreneaux[typePoils])) {
                    return;
                }

                allCreneaux[typePoils].forEach(creneau => {
                    const option = document.createElement("option");
                    option.value = creneau;
                    option.textContent = creneau;
                    selectCreneau.appendChild(option);
                });
            }

            // Prix
            const typePoils = racesData[animalType]?.[race];
            if (typePoils && prestation) {
                prixEstime.textContent = "Prix estimé : " + prixParPoils[typePoils][prestation] + "€";
            } else {
                prixEstime.textContent = "Prix estimé : 0€";
            }
        }

        // Vérifier si la date est un dimanche ou lundi
        function checkDay() {
            const selectedDate = new Date(dateInput.value);
            const day = selectedDate.getDay(); // 0 = dimanche, 1 = lundi
            if (day === 0 || day === 1) {
                errorDiv.textContent = "Les réservations ne sont pas possibles le dimanche et le lundi.";
                submitBtn.disabled = true;
            } else {
                errorDiv.textContent = "";
                submitBtn.disabled = false;
            }
        }

        // Écouteurs
        animalInputs.forEach(input => input.addEventListener("change", () => {
            populateRaces(input.value);
            updateCreneauxEtPrix();
        }));

        selectRace.addEventListener("change", updateCreneauxEtPrix);
        prestationSelect.addEventListener("change", updateCreneauxEtPrix);
        dateInput.addEventListener("change", checkDay);

        // Initialisation
        clearOptions(selectRace, "Sélectionner une race");
        clearOptions(selectCreneau, "Sélectionner un créneau");
        checkDay();

    </script>


{% endblock %}
